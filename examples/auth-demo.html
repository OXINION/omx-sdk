<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OMX SDK Authentication Test</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
      }
      .input-group {
        margin: 15px 0;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
      }
      input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-family: monospace;
      }
      button {
        background: #007aff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 5px 10px 0;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin: 20px 0;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 14px;
      }
      .success {
        background: #e8f5e8;
        border-left-color: #4caf50;
        color: #2e7d32;
      }
      .error {
        background: #ffebee;
        border-left-color: #f44336;
        color: #c62828;
      }
      .info {
        background: #e3f2fd;
        border-left-color: #2196f3;
        color: #1565c0;
      }
      .endpoint-info {
        background: #fff9c4;
        border: 1px solid #f57f17;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
      }
      .flow-diagram {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 20px;
        border-radius: 5px;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üéØ OMX SDK Authentication Test</h1>

      <div class="endpoint-info">
        <h3>üì° Authentication Endpoint</h3>
        <p>
          <strong>URL:</strong>
          <code
            >https://blhilidnsybhfdmwqsrx.supabase.co/functions/v1/create-jwt-token</code
          >
        </p>
        <p><strong>Method:</strong> POST</p>
        <p>
          <strong>Headers:</strong>
          <code>Authorization: Bearer [anon_key], apikey: [anon_key]</code>
        </p>
        <p>
          <strong>Body:</strong>
          <code>{ clientId: string, secretKey: string }</code>
        </p>
        <p>
          <strong>üîë Anon Key:</strong>
          <small><code>eyJhbGci...kS84c</code> (safe to use in browser)</small>
        </p>
      </div>

      <div class="input-group">
        <label for="clientId">Client ID:</label>
        <input
          type="text"
          id="clientId"
          value="f7b294c9-12d1-477b-b454-552dedd28de3"
          placeholder="Enter your clientId"
        />
      </div>

      <div class="input-group">
        <label for="secretKey">Secret Key:</label>
        <input
          type="password"
          id="secretKey"
          value="87654321-4321-4321-4321-987654321cba"
          placeholder="Enter your secretKey"
        />
      </div>

      <button onclick="testAuthentication()">üîê Test Authentication</button>
      <button onclick="testInvalidCredentials()">
        ‚ùå Test Invalid Credentials
      </button>
      <button onclick="showExpectedResponses()">
        üìö Show Expected Responses
      </button>
      <button onclick="testCORS()">üåê Test CORS & Connectivity</button>
      <button onclick="clearResults()">üßπ Clear Results</button>

      <div id="results"></div>

      <div class="flow-diagram">
        <h3>üîÑ Authentication Flow (5 Steps)</h3>
        <ol>
          <li><strong>Client:</strong> Provides clientId + secretKey</li>
          <li><strong>SDK:</strong> POST to Supabase Edge Function</li>
          <li><strong>Edge Function:</strong> Validates via Supabase RPC</li>
          <li><strong>Supabase:</strong> Generates and returns JWT</li>
          <li><strong>SDK:</strong> Stores token for API calls</li>
        </ol>
      </div>
    </div>

    <script>
      function addResult(message, type = 'info') {
        const results = document.getElementById('results');
        const div = document.createElement('div');
        div.className = `result ${type}`;
        div.textContent = message;
        results.appendChild(div);
        div.scrollIntoView({ behavior: 'smooth' });
      }

      function clearResults() {
        document.getElementById('results').innerHTML = '';
      }

      async function testAuthentication() {
        const clientId = document.getElementById('clientId').value;
        const secretKey = document.getElementById('secretKey').value;

        if (!clientId || !secretKey) {
          addResult('‚ùå Please enter both clientId and secretKey', 'error');
          return;
        }

        addResult('üöÄ Starting OMX SDK authentication test...', 'info');
        addResult(`üìã ClientId: ${clientId}`, 'info');
        addResult(`üîë SecretKey: ${secretKey.substring(0, 8)}...`, 'info');

        try {
          addResult(
            'üì° Making POST request to authentication endpoint...',
            'info'
          );

          const response = await fetch(
            'https://blhilidnsybhfdmwqsrx.supabase.co/functions/v1/create-jwt-token',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization:
                  'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsaGlsaWRuc3liaGZkbXdxc3J4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1MjM4OTgsImV4cCI6MjA2MDA5OTg5OH0.KZGJMcm2V7aW1tH7U0skvipE7h53212MRaaSm2kS84c',
                apikey:
                  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsaGlsaWRuc3liaGZkbXdxc3J4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1MjM4OTgsImV4cCI6MjA2MDA5OTg5OH0.KZGJMcm2V7aW1tH7U0skvipE7h53212MRaaSm2kS84c',
              },
              body: JSON.stringify({
                clientId: clientId,
                secretKey: secretKey,
              }),
            }
          );

          addResult(
            `üìä Response Status: ${response.status} ${response.statusText}`,
            response.ok ? 'success' : 'error'
          );

          const data = await response.text();
          let jsonData;

          try {
            jsonData = JSON.parse(data);
          } catch (e) {
            addResult(
              `üìÑ Raw Response: ${data}`,
              response.ok ? 'success' : 'error'
            );
            return;
          }

          if (response.ok) {
            if (jsonData.token) {
              addResult('‚úÖ Authentication successful!', 'success');
              addResult(
                `üéüÔ∏è JWT Token received (${jsonData.token.length} chars)`,
                'success'
              );
              addResult(
                `üìù Token preview: ${jsonData.token.substring(0, 50)}...`,
                'success'
              );

              // Verify JWT structure
              const tokenParts = jsonData.token.split('.');
              if (tokenParts.length === 3) {
                addResult(
                  '‚úÖ Valid JWT structure (header.payload.signature)',
                  'success'
                );

                // Try to decode JWT payload (base64)
                try {
                  const payload = JSON.parse(atob(tokenParts[1] + '=='));
                  addResult(
                    `üîç JWT Payload: ${JSON.stringify(payload, null, 2)}`,
                    'info'
                  );
                } catch (decodeError) {
                  addResult('‚ÑπÔ∏è Could not decode JWT payload', 'info');
                }
              }
            } else {
              addResult(
                `‚úÖ Response: ${JSON.stringify(jsonData, null, 2)}`,
                'success'
              );
            }
          } else {
            addResult(
              `‚ùå Authentication failed: ${JSON.stringify(jsonData, null, 2)}`,
              'error'
            );

            if (response.status === 401) {
              if (jsonData.message === 'Missing authorization header') {
                addResult(
                  'üí° The Edge Function is expecting an Authorization header. This suggests the function needs to be updated to handle clientId/secretKey in the request body.',
                  'error'
                );
              } else {
                addResult(
                  'üí° 401 Unauthorized: Check your clientId and secretKey',
                  'error'
                );
              }
            } else if (response.status === 500) {
              addResult(
                'üí° 500 Server Error: Authentication service issue',
                'error'
              );
            } else if (response.status === 400) {
              addResult(
                'üí° 400 Bad Request: Missing or invalid request parameters',
                'error'
              );
            }
          }
        } catch (error) {
          addResult(`‚ùå Network error: ${error.message}`, 'error');
          addResult('üí° Check your internet connection and try again', 'error');
        }
      }

      async function testInvalidCredentials() {
        addResult('üß™ Testing with invalid credentials...', 'info');

        try {
          const response = await fetch(
            'https://blhilidnsybhfdmwqsrx.supabase.co/functions/v1/create-jwt-token',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization:
                  'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsaGlsaWRuc3liaGZkbXdxc3J4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1MjM4OTgsImV4cCI6MjA2MDA5OTg5OH0.KZGJMcm2V7aW1tH7U0skvipE7h53212MRaaSm2kS84c',
                apikey:
                  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsaGlsaWRuc3liaGZkbXdxc3J4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1MjM4OTgsImV4cCI6MjA2MDA5OTg5OH0.KZGJMcm2V7aW1tH7U0skvipE7h53212MRaaSm2kS84c',
              },
              body: JSON.stringify({
                clientId: 'invalid-client-id',
                secretKey: 'invalid-secret-key',
              }),
            }
          );

          const data = await response.text();
          addResult(
            `üìä Invalid credentials test: ${response.status} ${response.statusText}`,
            'info'
          );
          addResult(`üìÑ Response: ${data}`, response.ok ? 'error' : 'success');

          if (!response.ok) {
            addResult('‚úÖ Correctly rejected invalid credentials', 'success');
          } else {
            addResult('‚ùå Should have rejected invalid credentials', 'error');
          }
        } catch (error) {
          addResult(
            `‚ùå Error testing invalid credentials: ${error.message}`,
            'error'
          );
        }
      }

      async function testCORS() {
        addResult(
          'üß™ Testing CORS & Connectivity (comprehensive test)...',
          'info'
        );
        addResult(
          '‚ÑπÔ∏è This test checks if the API can be reached and responds correctly',
          'info'
        );

        try {
          // Test OPTIONS request first (without custom headers to avoid preflight issues)
          addResult('üîç Testing simple OPTIONS request...', 'info');
          const simpleOptionsResponse = await fetch(
            'https://blhilidnsybhfdmwqsrx.supabase.co/functions/v1/create-jwt-token',
            {
              method: 'OPTIONS',
            }
          );

          addResult(
            `üìä Simple OPTIONS Response: ${simpleOptionsResponse.status} ${simpleOptionsResponse.statusText}`,
            simpleOptionsResponse.ok ? 'success' : 'error'
          );

          // Check CORS headers from simple OPTIONS
          const corsHeaders = [
            'Access-Control-Allow-Origin',
            'Access-Control-Allow-Methods',
            'Access-Control-Allow-Headers',
            'Access-Control-Max-Age',
          ];

          corsHeaders.forEach((header) => {
            const value = simpleOptionsResponse.headers.get(header);
            addResult(
              `üîç ${header}: ${value || 'Not set'}`,
              value ? 'success' : 'error'
            );
          });

          // Test preflight OPTIONS request (with custom headers)
          addResult('üîç Testing preflight OPTIONS request...', 'info');
          const preflightResponse = await fetch(
            'https://blhilidnsybhfdmwqsrx.supabase.co/functions/v1/create-jwt-token',
            {
              method: 'OPTIONS',
              headers: {
                'Access-Control-Request-Method': 'POST',
                'Access-Control-Request-Headers':
                  'content-type, authorization, apikey',
                Origin: window.location.origin,
              },
            }
          );

          addResult(
            `üìä Preflight OPTIONS Response: ${preflightResponse.status} ${preflightResponse.statusText}`,
            preflightResponse.ok ? 'success' : 'error'
          );

          // Test a simple POST without credentials (expect 400 - this is normal!)
          addResult(
            'üß™ Testing POST without credentials (should return 400)...',
            'info'
          );
          const postResponse = await fetch(
            'https://blhilidnsybhfdmwqsrx.supabase.co/functions/v1/create-jwt-token',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization:
                  'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsaGlsaWRuc3liaGZkbXdxc3J4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1MjM4OTgsImV4cCI6MjA2MDA5OTg5OH0.KZGJMcm2V7aW1tH7U0skvipE7h53212MRaaSm2kS84c',
                apikey:
                  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsaGlsaWRuc3liaGZkbXdxc3J4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1MjM4OTgsImV4cCI6MjA2MDA5OTg5OH0.KZGJMcm2V7aW1tH7U0skvipE7h53212MRaaSm2kS84c',
              },
              body: JSON.stringify({}),
            }
          );

          const postData = await postResponse.text();
          addResult(
            `üìä POST Response: ${postResponse.status} ${postResponse.statusText}`,
            postResponse.status === 400 ? 'success' : 'error'
          );
          addResult(`üìÑ POST Body: ${postData}`, 'info');

          if (postResponse.status === 400) {
            addResult(
              '‚úÖ Correctly returned 400 for missing credentials (CORS working!)',
              'success'
            );
          } else {
            addResult(
              '‚ùå Unexpected response - should be 400 for missing credentials',
              'error'
            );
          }

          // Test network connectivity
          addResult('üåê Testing basic connectivity to Supabase...', 'info');
          try {
            const connectivityTest = await fetch(
              'https://blhilidnsybhfdmwqsrx.supabase.co/rest/v1/',
              {
                method: 'GET',
                headers: {
                  apikey:
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsaGlsaWRuc3liaGZkbXdxc3J4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1MjM4OTgsImV4cCI6MjA2MDA5OTg5OH0.KZGJMcm2V7aW1tH7U0skvipE7h53212MRaaSm2kS84c',
                },
              }
            );
            addResult(
              `üì° Supabase API connectivity: ${connectivityTest.status} ${connectivityTest.statusText}`,
              connectivityTest.ok ? 'success' : 'info'
            );
          } catch (connError) {
            addResult(
              `‚ùå Connectivity test failed: ${connError.message}`,
              'error'
            );
          }

          // Summary
          addResult('üìã CORS Test Summary:', 'info');
          addResult(
            '‚úÖ If OPTIONS requests return 200 and POST returns 400 (missing credentials), CORS is working correctly!',
            'success'
          );
        } catch (error) {
          addResult(`‚ùå CORS test error: ${error.message}`, 'error');
          addResult(
            `üîç Error details: ${error.stack || 'No stack trace'}`,
            'error'
          );
        }
      }

      function showExpectedResponses() {
        addResult('üìö Expected API Responses:', 'info');
        addResult('', 'info');

        addResult('‚úÖ Success Response:', 'success');
        addResult(
          JSON.stringify(
            {
              token:
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJmN2IyOTRjOS0xMmQxLTQ3N2ItYjQ1NC01NTJkZWRkMjhkZTMiLCJpYXQiOjE2OTk5MzU2MDAsImV4cCI6MTY5OTk0MjgwMH0.signature_here',
            },
            null,
            2
          ),
          'success'
        );

        addResult('‚ùå Error Response (401 Unauthorized):', 'error');
        addResult(
          JSON.stringify(
            {
              error: 'invalid credentials',
            },
            null,
            2
          ),
          'error'
        );

        addResult('‚ùå Error Response (500 Server Error):', 'error');
        addResult(
          JSON.stringify(
            {
              error: 'Internal server error',
            },
            null,
            2
          ),
          'error'
        );
      }

      // Show initial instructions
      addResult('üëã Welcome to OMX SDK Authentication Test!', 'info');
      addResult(
        'üîß Configure your clientId and secretKey above, then click "Test Authentication"',
        'info'
      );
      addResult(
        'üí° You can get your credentials from omx.oxinion.com/token',
        'info'
      );
    </script>
  </body>
</html>
