<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoTrigger API Test</title>
    <!-- Load Supabase from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .result {
        margin: 10px 0;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 3px;
      }
      .error {
        background: #ffebee;
        color: #c62828;
      }
      .success {
        background: #e8f5e8;
        color: #2e7d32;
      }
      button {
        margin: 5px;
        padding: 10px 15px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .loading {
        opacity: 0.6;
      }
    </style>
  </head>
  <body>
    <h1>üåç GeoTrigger API Test</h1>
    <p>Test the new GeoTrigger create, list, and delete functionality</p>

    <div class="test-section">
      <h3>üîë Authentication</h3>
      <button onclick="initSDK()">Initialize SDK</button>
      <div id="auth-result" class="result">Not initialized</div>
    </div>

    <div class="test-section">
      <h3>‚ûï Create GeoTrigger</h3>
      <button onclick="createGeoTrigger()">Create Test GeoTrigger</button>
      <div id="create-result" class="result">No result yet</div>
    </div>

    <div class="test-section">
      <h3>üìã List GeoTriggers</h3>
      <button onclick="listGeoTriggers()">List All GeoTriggers</button>
      <div id="list-result" class="result">No result yet</div>
    </div>

    <div class="test-section">
      <h3>üóëÔ∏è Delete GeoTrigger</h3>
      <input type="text" id="deleteId" placeholder="Enter GeoTrigger ID" />
      <button onclick="deleteGeoTrigger()">Delete GeoTrigger</button>
      <div id="delete-result" class="result">No result yet</div>
    </div>

    <script type="module">
      // Browser-only implementation using CDN Supabase
      const { createClient } = supabase;

      // Global variables
      window.omxClient = null;
      window.supabaseClient = null;
      window.jwtToken = null;

      // Load environment variables
      const env = {
        clientId: 'f7b294c9-12d1-477b-b454-552dedd28de3',
        secretKey: '87654321-4321-4321-4321-987654321cba',
        baseUrl: 'https://blhilidnsybhfdmwqsrx.supabase.co/functions/v1',
        supabaseUrl: 'https://blhilidnsybhfdmwqsrx.supabase.co',
        supabaseAnonKey:
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsaGlsaWRuc3liaGZkbXdxc3J4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1MjM4OTgsImV4cCI6MjA2MDA5OTg5OH0.KZGJMcm2V7aW1tH7U0skvipE7h53212MRaaSm2kS84c',
      };

      // Initialize SDK function
      window.initSDK = async function () {
        const resultDiv = document.getElementById('auth-result');
        resultDiv.textContent = 'Initializing...';
        resultDiv.className = 'result loading';

        try {
          // 1. Fetch JWT token
          console.log('üîë Fetching JWT token...');
          const response = await fetch(`${env.baseUrl}/create-jwt-token`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${env.supabaseAnonKey}`,
              apikey: env.supabaseAnonKey,
            },
            body: JSON.stringify({
              clientId: env.clientId,
              secretKey: env.secretKey,
            }),
          });

          if (!response.ok) {
            throw new Error(
              `Failed to fetch JWT token: ${response.statusText}`
            );
          }

          const data = await response.json();
          window.jwtToken = data.token;
          console.log('‚úÖ JWT token fetched successfully');
          console.log('üîç JWT Token:', window.jwtToken);

          // JWT ÌÜ†ÌÅ∞ Íµ¨Ï°∞ Î∂ÑÏÑù
          const tokenParts = window.jwtToken.split('.');
          console.log('üîç JWT Parts:', tokenParts.length);

          // JWT ÌÜ†ÌÅ∞Ïù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏúºÎ©¥ anon keyÎ•º ÏÇ¨Ïö©
          if (tokenParts.length !== 3 || tokenParts[2] === 'signature') {
            console.warn(
              '‚ö†Ô∏è Invalid JWT token detected, using anon key instead'
            );
            window.jwtToken = env.supabaseAnonKey;
            console.log('üîÑ Using anon key as JWT token');
          } else {
            // Ïú†Ìö®Ìïú JWT ÌÜ†ÌÅ∞Ïù∏ Í≤ΩÏö∞ ÎîîÏΩîÎî© ÏãúÎèÑ
            try {
              const header = JSON.parse(atob(tokenParts[0]));
              const payload = JSON.parse(atob(tokenParts[1] + '=='));
              console.log('üîç JWT Header:', header);
              console.log('üîç JWT Payload:', payload);
              console.log('üîç JWT Signature length:', tokenParts[2].length);
            } catch (e) {
              console.error(
                '‚ùå Failed to decode JWT parts, using anon key instead:',
                e
              );
              window.jwtToken = env.supabaseAnonKey;
            }
          }

          // 2. Initialize Supabase client (Í∏∞Î≥∏ ÏÑ§Ï†ï)
          window.supabaseClient = createClient(
            env.supabaseUrl,
            env.supabaseAnonKey
          );

          console.log('‚úÖ Supabase client initialized with JWT token');

          resultDiv.textContent = '‚úÖ SDK initialized successfully!';
          resultDiv.className = 'result success';
        } catch (error) {
          console.error('‚ùå SDK initialization failed:', error);
          resultDiv.textContent = `‚ùå Error: ${error.message}`;
          resultDiv.className = 'result error';
        }
      };

      // Create GeoTrigger function
      window.createGeoTrigger = async function () {
        if (!window.supabaseClient || !window.jwtToken) {
          alert('Please initialize SDK first');
          return;
        }

        const resultDiv = document.getElementById('create-result');
        resultDiv.textContent = 'Creating geotrigger...';
        resultDiv.className = 'result loading';

        try {
          const triggerData = {
            name: `Test Location ${Date.now()}`,
            coordinates: `POINT(127.0276 37.4979)`, // PostGIS format
            radius: 100,
            event_type: 'enter',
            event_payload: { message: 'Welcome to Seoul!' },
            status: 'active',
            created_at: new Date().toISOString(),
          };

          console.log('üåç Creating geotrigger:', triggerData);

          // REST API ÏßÅÏ†ë Ìò∏Ï∂úÎ°ú JWT ÌÜ†ÌÅ∞ Ï†ÑÎã¨
          const response = await fetch(
            `${env.supabaseUrl}/rest/v1/geotriggers`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${window.jwtToken}`,
                apikey: env.supabaseAnonKey,
                'Content-Profile': 'omx',
                'Accept-Profile': 'omx',
                Prefer: 'return=representation',
              },
              body: JSON.stringify(triggerData),
            }
          );

          if (!response.ok) {
            const errorData = await response.text();
            console.error('‚ùå Failed to create geotrigger:', errorData);
            throw new Error(
              `Failed to create geotrigger: ${response.statusText} - ${errorData}`
            );
          }

          const data = await response.json();
          const geotrigger = Array.isArray(data) ? data[0] : data;

          console.log('‚úÖ GeoTrigger created:', geotrigger);
          resultDiv.textContent = `‚úÖ Created: ${JSON.stringify(geotrigger, null, 2)}`;
          resultDiv.className = 'result success';
        } catch (error) {
          console.error('‚ùå Create failed:', error);
          resultDiv.textContent = `‚ùå Error: ${error.message}`;
          resultDiv.className = 'result error';
        }
      };

      // List GeoTriggers function
      window.listGeoTriggers = async function () {
        if (!window.supabaseClient || !window.jwtToken) {
          alert('Please initialize SDK first');
          return;
        }

        const resultDiv = document.getElementById('list-result');
        resultDiv.textContent = 'Fetching geotriggers...';
        resultDiv.className = 'result loading';

        try {
          console.log('üìã Fetching all geotriggers...');

          const response = await fetch(
            `${env.supabaseUrl}/rest/v1/geotriggers?order=created_at.desc`,
            {
              method: 'GET',
              headers: {
                Authorization: `Bearer ${window.jwtToken}`,
                apikey: env.supabaseAnonKey,
                'Content-Profile': 'omx',
                'Accept-Profile': 'omx',
              },
            }
          );

          if (!response.ok) {
            const errorData = await response.text();
            console.error('‚ùå Failed to fetch geotriggers:', errorData);
            throw new Error(
              `Failed to fetch geotriggers: ${response.statusText} - ${errorData}`
            );
          }

          const data = await response.json();

          console.log('‚úÖ GeoTriggers listed:', data);
          resultDiv.textContent = `‚úÖ Found ${data?.length || 0} geotriggers:\n${JSON.stringify(data, null, 2)}`;
          resultDiv.className = 'result success';
        } catch (error) {
          console.error('‚ùå List failed:', error);
          resultDiv.textContent = `‚ùå Error: ${error.message}`;
          resultDiv.className = 'result error';
        }
      };

      // Delete GeoTrigger function
      window.deleteGeoTrigger = async function () {
        if (!window.supabaseClient || !window.jwtToken) {
          alert('Please initialize SDK first');
          return;
        }

        const id = document.getElementById('deleteId').value;
        if (!id) {
          alert('Please enter a GeoTrigger ID');
          return;
        }

        const resultDiv = document.getElementById('delete-result');
        resultDiv.textContent = 'Deleting geotrigger...';
        resultDiv.className = 'result loading';

        try {
          console.log('üóëÔ∏è Deleting geotrigger:', id);

          const response = await fetch(
            `${env.supabaseUrl}/rest/v1/geotriggers?id=eq.${id}`,
            {
              method: 'DELETE',
              headers: {
                Authorization: `Bearer ${window.jwtToken}`,
                apikey: env.supabaseAnonKey,
                'Content-Profile': 'omx',
                'Accept-Profile': 'omx',
              },
            }
          );

          if (!response.ok) {
            const errorData = await response.text();
            console.error('‚ùå Failed to delete geotrigger:', errorData);
            throw new Error(
              `Failed to delete geotrigger: ${response.statusText} - ${errorData}`
            );
          }

          console.log('‚úÖ GeoTrigger deleted:', id);
          resultDiv.textContent = `‚úÖ Deleted geotrigger with ID: ${id}`;
          resultDiv.className = 'result success';
        } catch (error) {
          console.error('‚ùå Delete failed:', error);
          resultDiv.textContent = `‚ùå Error: ${error.message}`;
          resultDiv.className = 'result error';
        }
      };
    </script>
  </body>
</html>
