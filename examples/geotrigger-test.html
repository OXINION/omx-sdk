<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Geotrigger Module Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #4ade80 0%, #22d3ee 100%);
        min-height: 100vh;
      }
      .container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }
      .section {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #10b981;
      }
      button {
        background: #10b981;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        margin: 5px;
        transition: all 0.3s ease;
      }
      button:hover {
        background: #059669;
        transform: translateY(-2px);
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
      }
      #output {
        background: #1a202c;
        color: #e2e8f0;
        padding: 20px;
        border-radius: 10px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 500px;
        overflow-y: auto;
        margin-top: 20px;
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      .full-width {
        grid-column: 1 / -1;
      }
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .status-connected {
        background-color: #10b981;
      }
      .status-disconnected {
        background-color: #ef4444;
      }
      .status-pending {
        background-color: #f59e0b;
      }
      .warning-box {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        color: #92400e;
      }
      .success-box {
        background: #d1fae5;
        border: 1px solid #a7f3d0;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        color: #065f46;
      }
      .error-box {
        background: #fee2e2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        color: #991b1b;
      }
      .location-display {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        color: #1e40af;
      }
      .map-container {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        color: #6b7280;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üåç Geotrigger Module Test (Enhanced Version)</h1>

      <div class="warning-box">
        <h4>‚ö†Ô∏è Test Guide</h4>
        <p>
          ‚Ä¢ Click <strong>"Initialize Geotrigger Client"</strong> to get started
        </p>
        <p>
          ‚Ä¢ Test database-access function through Edge Functions with JWT authentication
        </p>
        <p>‚Ä¢ Full CRUD operations and browser location services</p>
      </div>

      <div class="section">
        <h3>üìä Connection Status</h3>
        <p id="connection-status">
          <span
            class="status-indicator status-pending"
            id="status-indicator"
          ></span>
          <span id="status-text">Ready to initialize</span>
        </p>
      </div>

      <div class="section">
        <h3>üîë Authentication</h3>
        <div class="form-grid">
          <div>
            <label for="clientId">Client ID:</label>
            <input
              type="text"
              id="clientId"
              value="8ac9ed2e-7a81-4caf-b2ed-ecb8f025fef9"
            />
          </div>
          <div>
            <label for="secretKey">Secret Key:</label>
            <input
              type="password"
              id="secretKey"
              value="9c5fc630-5304-4b6d-957d-f8767e5fe809"
            />
          </div>
          <div class="full-width">
            <label for="teamId">Team ID (optional):</label>
            <input
              type="text"
              id="teamId"
              placeholder="Leave empty to auto-generate"
            />
          </div>
        </div>
      </div>

      <div class="section">
        <h3>üß™ SDK Actions</h3>
        <button onclick="initializeGeotriggerClient()">
          Initialize Geotrigger Client
        </button>
        <button onclick="testAuthentication()" id="authBtn" disabled>
          Test Authentication
        </button>
        <button onclick="listGeotriggers()" id="listBtn" disabled>
          List Geotriggers
        </button>
        <button onclick="getGeotriggerStats()" id="statsBtn" disabled>
          Get Geotrigger Stats
        </button>
        <button onclick="clearOutput()">Clear Output</button>
      </div>

      <div class="section">
        <h3>üìç Location Services</h3>
        <button onclick="getCurrentLocation()" id="locationBtn" disabled>
          Get Current Location
        </button>
        <button onclick="startMonitoring()" id="monitorBtn" disabled>
          Start Geofence Monitoring
        </button>
        <button onclick="stopMonitoring()" id="stopBtn" disabled>
          Stop Monitoring
        </button>
        <div id="location-display" class="location-display" style="display: none;">
          <h4>üìç Current Location</h4>
          <p id="location-info">No location data yet</p>
        </div>
        <div class="map-container">
          <p>üó∫Ô∏è Map integration coming soon</p>
          <small>Use browser location services to test geofence functionality</small>
        </div>
      </div>

      <div class="section">
        <h3>‚ûï Create Geotrigger</h3>
        <div class="form-grid">
          <div>
            <label for="geotriggerName">Name: *</label>
            <input
              type="text"
              id="geotriggerName"
              value="SDK Test Geotrigger"
              required
            />
          </div>
          <div>
            <label for="geotriggerRadius">Radius (meters): *</label>
            <input
              type="number"
              id="geotriggerRadius"
              value="100"
              min="1"
              max="10000"
              required
            />
          </div>
          <div>
            <label for="geotriggerLatitude">Latitude: *</label>
            <input
              type="number"
              id="geotriggerLatitude"
              value="37.7749"
              step="0.000001"
              required
            />
          </div>
          <div>
            <label for="geotriggerLongitude">Longitude: *</label>
            <input
              type="number"
              id="geotriggerLongitude"
              value="-122.4194"
              step="0.000001"
              required
            />
          </div>
          <div>
            <label for="geotriggerEventType">Event Type:</label>
            <select id="geotriggerEventType">
              <option value="webhook">Webhook</option>
              <option value="email">Email</option>
              <option value="campaign">Campaign</option>
            </select>
          </div>
          <div>
            <label for="geotriggerStatus">Status:</label>
            <select id="geotriggerStatus">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          <div class="full-width">
            <label for="geotriggerDescription">Description:</label>
            <textarea id="geotriggerDescription" rows="3">
Geotrigger created via OMX SDK test interface</textarea>
          </div>
          <div class="full-width">
            <label for="geotriggerPayload">Event Payload (JSON):</label>
            <textarea id="geotriggerPayload" rows="4">{
  "webhook_url": "https://your-app.com/webhook",
  "message": "Welcome to this location!",
  "priority": "high"
}</textarea>
          </div>
          <div class="full-width">
            <button onclick="createGeotrigger()" id="createBtn" disabled>
              Create Geotrigger
            </button>
            <button onclick="useCurrentLocation()" id="useLocationBtn" disabled>
              Use Current Location
            </button>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>üîÑ Geotrigger Management</h3>
        <div class="form-grid">
          <div>
            <label for="managementId">Geotrigger ID:</label>
            <input
              type="text"
              id="managementId"
              placeholder="Enter geotrigger ID"
            />
          </div>
          <div>
            <label for="newStatus">New Status:</label>
            <select id="newStatus">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          <div class="full-width">
            <button onclick="getGeotrigger()" id="getBtn" disabled>
              Get Geotrigger
            </button>
            <button onclick="updateGeotriggerStatus()" id="updateStatusBtn" disabled>
              Update Status
            </button>
            <button onclick="duplicateGeotrigger()" id="duplicateBtn" disabled>
              Duplicate Geotrigger
            </button>
            <button onclick="deleteGeotrigger()" id="deleteBtn" disabled>
              Delete Geotrigger
            </button>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>üìÑ Test Output</h3>
        <div id="output">Geotrigger Module Test Ready (Enhanced Version)...\n</div>
      </div>
    </div>

    <script>
      let geotriggerClient = null;
      let authToken = null;
      let currentTeamId = null;
      let watchId = null;
      let currentLocation = null;

      function log(message, type = "info") {
        const output = document.getElementById("output");
        const timestamp = new Date().toLocaleTimeString();
        const prefix =
          {
            success: "‚úÖ",
            error: "‚ùå",
            warning: "‚ö†Ô∏è",
            info: "‚ÑπÔ∏è",
            location: "üìç",
          }[type] || "‚ÑπÔ∏è";

        output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
        output.scrollTop = output.scrollHeight;
      }

      function updateStatus(status, text) {
        const indicator = document.getElementById("status-indicator");
        const statusText = document.getElementById("status-text");
        indicator.className = `status-indicator status-${status}`;
        statusText.textContent = text;
      }

      function enableButtons() {
        ["authBtn", "listBtn", "statsBtn", "createBtn", "getBtn", "updateStatusBtn", 
         "duplicateBtn", "deleteBtn", "locationBtn", "monitorBtn", "useLocationBtn"].forEach(
          (id) => {
            document.getElementById(id).disabled = false;
          }
        );
      }

      function clearOutput() {
        document.getElementById("output").textContent = "Output cleared...\n";
      }

      // Enhanced Geotrigger Client
      class GeotriggerClient {
        constructor(clientId, secretKey, teamId) {
          this.clientId = clientId;
          this.secretKey = secretKey;
          this.teamId = teamId || this.createUUID();
          this.authToken = null;
          this.baseUrl =
            "https://blhilidnsybhfdmwqsrx.supabase.co/functions/v1";
          this.regions = new Map();
          this.isWatching = false;
          this.watchId = null;
        }

        createUUID() {
          return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
            /[xy]/g,
            function (c) {
              const r = (Math.random() * 16) | 0;
              const v = c == "x" ? r : (r & 0x3) | 0x8;
              return v.toString(16);
            }
          );
        }

        async getAuthToken() {
          if (!this.authToken) {
            log("üîê Authenticating with Edge Function...", "info");

            const response = await fetch(`${this.baseUrl}/create-jwt-token`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                clientId: this.clientId,
                secretKey: this.secretKey,
              }),
            });

            if (!response.ok) {
              throw new Error(`Authentication failed: ${response.statusText}`);
            }

            const data = await response.json();
            this.authToken = data.token;

            // Extract client_id from JWT (simplified - no team lookup needed)
            try {
              if (this.authToken) {
                const payload = JSON.parse(atob(this.authToken.split(".")[1]));
                log(`üîç JWT payload: ${JSON.stringify(payload, null, 2)}`, "info");
                
                if (payload.client_id) {
                  log(`üÜî Client ID from JWT: ${payload.client_id}`, "success");
                  // Use a generated teamId since we don't need to look it up from API keys
                  if (!this.teamId) {
                    this.teamId = this.createUUID();
                  }
                  log(`üÜî Using Team ID: ${this.teamId}`, "info");
                }
              }
            } catch (error) {
              log("‚ö†Ô∏è Failed to decode JWT", "warning");
              throw new Error("Invalid JWT received");
            }
          }
          return this.authToken;
        }

        async loadTeamIdFromApiKeys() {
          try {
            log(`üîç Looking up team_id for client_id: ${this.clientId}`, "info");

            const url = `${this.baseUrl}/database-access?table=api_keys&schema=business`;

            const response = await fetch(url, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${this.authToken}`,
              },
              body: JSON.stringify({
                filters: { client_id: this.clientId },
              }),
            });

            if (response.ok) {
              const result = await response.json();
              log(`üîç API keys lookup result: ${JSON.stringify(result, null, 2)}`, "info");

              if (result.success && result.data && result.data.length > 0) {
                const apiKey = result.data[0];
                if (apiKey.team_id) {
                  this.teamId = apiKey.team_id;
                  log(`üÜî Team ID from API keys: ${this.teamId}`, "success");
                } else {
                  log(`‚ö†Ô∏è API key found but no team_id: ${JSON.stringify(apiKey)}`, "warning");
                }
              } else {
                log(`‚ö†Ô∏è No API key found for client_id: ${this.clientId}`, "warning");
                log(`‚ö†Ô∏è Using fallback team_id: ${this.teamId}`, "warning");
              }
            } else {
              const errorText = await response.text();
              log(`‚ö†Ô∏è Failed to lookup API key: ${errorText}`, "warning");
            }
          } catch (error) {
            log(`‚ö†Ô∏è Failed to load team_id from API keys: ${error.message}`, "warning");
            log(`‚ö†Ô∏è Using fallback team_id: ${this.teamId}`, "warning");
          }
        }

        async makeRequest(endpoint, data = {}) {
          const token = await this.getAuthToken();

          let url, method = "POST", body;

          switch (endpoint) {
            case "geotrigger-list":
              url = `${this.baseUrl}/database-access?table=workflow_nodes&schema=omx`;
              body = JSON.stringify({
                filters: { 
                  type: "geotrigger",
                  ...data.filters 
                },
                // Note: team_id filtering will need to be handled via workflow join or config filter
              });
              break;

            case "geotrigger-create":
              // Ensure we have a workflow_id
              const workflowId = data.workflow_id || await this.ensureDefaultWorkflow();
              
              url = `${this.baseUrl}/database-access?table=workflow_nodes&schema=omx`;
              body = JSON.stringify({
                action: "create",
                data: {
                  workflow_id: workflowId, // Required field
                  type: "geotrigger",
                  config: {
                    name: data.name,
                    description: data.description,
                    location: data.location,
                    coordinates: data.coordinates,
                    radius: data.radius,
                    event_type: data.event_type,
                    event_payload: data.event_payload,
                    status: data.status || "active",
                    team_id: this.teamId,
                  },
                  position: data.position || { x: 0, y: 0 },
                  node_key: data.node_key || `geotrigger-${Date.now()}`,
                  created_at: new Date().toISOString(),
                  updated_at: new Date().toISOString(),
                },
              });
              break;

            case "geotrigger-get":
              url = `${this.baseUrl}/database-access?table=workflow_nodes&schema=omx`;
              body = JSON.stringify({
                filters: { 
                  id: data.id, 
                  type: "geotrigger"
                },
              });
              break;

            case "geotrigger-update":
              url = `${this.baseUrl}/database-access?table=workflow_nodes&schema=omx`;
              const updatePayload = {
                action: "update",
                filters: { 
                  id: data.id, 
                  type: "geotrigger"
                },
                data: {
                  config: data.updates, // data.updates is now the complete merged config
                  updated_at: new Date().toISOString(),
                },
              };
              body = JSON.stringify(updatePayload);
              log(`üîç Update payload: ${JSON.stringify(updatePayload, null, 2)}`, "info");
              break;

            case "geotrigger-delete":
              url = `${this.baseUrl}/database-access?table=workflow_nodes&schema=omx`;
              body = JSON.stringify({
                action: "delete",
                filters: { 
                  id: data.id, 
                  type: "geotrigger"
                },
              });
              break;

            case "geotrigger-stats":
              const geotriggers = await this.listGeotriggers();
              return {
                totalGeotriggers: geotriggers.length,
                activeGeotriggers: geotriggers.filter((g) => g.config?.status === "active").length,
                inactiveGeotriggers: geotriggers.filter((g) => g.config?.status === "inactive").length,
                teamId: this.teamId,
              };

            default:
              url = `${this.baseUrl}/database-access`;
              body = JSON.stringify({ ...data, teamId: this.teamId });
          }

          const response = await fetch(url, {
            method,
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body,
          });

          if (!response.ok) {
            const errorText = await response.text();
            log(`‚ùå ${endpoint} failed: ${errorText}`, "error");
            throw new Error(`${endpoint} failed: ${response.statusText}`);
          }

          const result = await response.json();
          log(`‚úÖ ${endpoint} response: ${JSON.stringify(result, null, 2)}`, "info");

          if (result.success !== undefined) {
            if (!result.success) {
              throw new Error(result.error || "Database operation failed");
            }
            return result.data;
          }

          return result.data || result;
        }

        async createGeotrigger(data) {
          return this.makeRequest("geotrigger-create", data);
        }

        async listGeotriggers(filters = {}) {
          return this.makeRequest("geotrigger-list", { filters });
        }

        async getGeotrigger(id) {
          const result = await this.makeRequest("geotrigger-get", { id });
          return Array.isArray(result) ? result[0] : result;
        }

        async updateGeotrigger(id, updates) {
          // First get the current geotrigger to merge configs properly
          const current = await this.getGeotrigger(id);
          const mergedConfig = {
            ...current.config,
            ...updates,
            team_id: this.teamId // Ensure team_id is always present
          };
          
          return this.makeRequest("geotrigger-update", { 
            id, 
            updates: mergedConfig 
          });
        }

        async deleteGeotrigger(id) {
          await this.makeRequest("geotrigger-delete", { id });
        }

        async updateGeotriggerStatus(id, status) {
          await this.updateGeotrigger(id, { status });
        }

        async duplicateGeotrigger(id, newName) {
          const original = await this.getGeotrigger(id);
          const duplicateData = {
            name: newName || `${original.config?.name || 'Geotrigger'} (Copy)`,
            description: original.config?.description,
            location: original.config?.location,
            coordinates: original.config?.coordinates,
            radius: original.config?.radius,
            event_type: original.config?.event_type,
            event_payload: original.config?.event_payload,
            status: "inactive",
            team_id: this.teamId,
          };
          return this.createGeotrigger(duplicateData);
        }

        async getGeotriggerStats() {
          return this.makeRequest("geotrigger-stats", {});
        }

        async authenticate() {
          return this.getAuthToken();
        }

        async ensureDefaultWorkflow() {
          const token = await this.getAuthToken();
          
          // First, try to find existing default workflow for geotriggers
          const listUrl = `${this.baseUrl}/database-access?table=workflows&schema=business`;
          const listResponse = await fetch(listUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              filters: { 
                team_id: this.teamId,
                name: "Default Geotrigger Workflow"
              },
            }),
          });

          if (listResponse.ok) {
            const result = await listResponse.json();
            if (result.success && result.data && result.data.length > 0) {
              log(`‚úÖ Found existing default workflow: ${result.data[0].id}`, "success");
              return result.data[0].id;
            }
          }

          // Create default workflow if it doesn't exist
          log(`üîÑ Creating default workflow for team: ${this.teamId}`, "info");
          const createUrl = `${this.baseUrl}/database-access?table=workflows&schema=business`;
          const createResponse = await fetch(createUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              action: "create",
              data: {
                team_id: this.teamId,
                name: "Default Geotrigger Workflow",
                description: "Automatically created workflow for geotrigger nodes",
                status: "active",
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
              },
            }),
          });

          if (!createResponse.ok) {
            throw new Error(`Failed to create default workflow: ${createResponse.statusText}`);
          }

          const createResult = await createResponse.json();
          if (!createResult.success) {
            throw new Error(createResult.error || "Failed to create default workflow");
          }

          const workflowId = createResult.data.id || createResult.data[0]?.id;
          log(`‚úÖ Created default workflow: ${workflowId}`, "success");
          return workflowId;
        }

        // Browser location methods
        addRegion(region) {
          this.regions.set(region.id, region);
          log(`Added geofence region: ${region.id}`, "location");
        }

        removeRegion(regionId) {
          const removed = this.regions.delete(regionId);
          if (removed) {
            log(`Removed geofence region: ${regionId}`, "location");
          }
          return removed;
        }

        getRegions() {
          return Array.from(this.regions.values());
        }

        startMonitoring(onTrigger, options = {}) {
          return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
              reject(new Error("Geolocation is not supported by this browser"));
              return;
            }

            if (this.isWatching) {
              resolve();
              return;
            }

            const watchOptions = {
              enableHighAccuracy: options.enableHighAccuracy ?? true,
              timeout: options.timeout ?? 10000,
              maximumAge: options.maximumAge ?? 60000,
            };

            this.watchId = navigator.geolocation.watchPosition(
              (position) => {
                const currentLocation = {
                  latitude: position.coords.latitude,
                  longitude: position.coords.longitude,
                  accuracy: position.coords.accuracy,
                };

                this.checkRegions(currentLocation, onTrigger);
              },
              (error) => {
                log(`Geolocation error: ${error.message}`, "error");
                reject(error);
              },
              watchOptions
            );

            this.isWatching = true;
            resolve();
          });
        }

        stopMonitoring() {
          if (this.watchId !== null) {
            navigator.geolocation.clearWatch(this.watchId);
            this.watchId = null;
          }
          this.isWatching = false;
          log("Stopped geofence monitoring", "location");
        }

        getCurrentLocation(options = {}) {
          return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
              reject(new Error("Geolocation is not supported by this browser"));
              return;
            }

            const locationOptions = {
              enableHighAccuracy: options.enableHighAccuracy ?? true,
              timeout: options.timeout ?? 10000,
              maximumAge: options.maximumAge ?? 60000,
            };

            navigator.geolocation.getCurrentPosition(
              (position) => {
                resolve({
                  latitude: position.coords.latitude,
                  longitude: position.coords.longitude,
                  accuracy: position.coords.accuracy,
                });
              },
              (error) => {
                reject(error);
              },
              locationOptions
            );
          });
        }

        calculateDistance(loc1, loc2) {
          const R = 6371e3; // Earth's radius in meters
          const œÜ1 = (loc1.latitude * Math.PI) / 180;
          const œÜ2 = (loc2.latitude * Math.PI) / 180;
          const ŒîœÜ = ((loc2.latitude - loc1.latitude) * Math.PI) / 180;
          const ŒîŒª = ((loc2.longitude - loc1.longitude) * Math.PI) / 180;

          const a =
            Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
            Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

          return R * c;
        }

        checkRegions(currentLocation, onTrigger) {
          this.regions.forEach((region) => {
            const distance = this.calculateDistance(currentLocation, region.center);
            const isInside = distance <= region.radius;

            if (isInside) {
              const event = {
                regionId: region.id,
                type: "enter",
                location: currentLocation,
                timestamp: new Date(),
              };
              onTrigger(event);
            }
          });
        }

        isMonitoring() {
          return this.isWatching;
        }
      }

      // Global functions
      window.initializeGeotriggerClient = function () {
        const clientId = document.getElementById("clientId").value.trim();
        const secretKey = document.getElementById("secretKey").value.trim();
        const teamId = document.getElementById("teamId").value.trim();

        if (!clientId || !secretKey) {
          log("‚ùå Please enter both clientId and secretKey", "error");
          return;
        }

        try {
          log("üöÄ Initializing Geotrigger Client...", "info");
          log(`üìã Client ID: ${clientId}`, "info");
          log(`üîë Secret Key: ${secretKey.substring(0, 8)}...`, "info");
          updateStatus("pending", "Initializing...");

          geotriggerClient = new GeotriggerClient(clientId, secretKey, teamId);
          currentTeamId = geotriggerClient.teamId;

          log("‚úÖ Geotrigger Client initialized successfully!", "success");
          log(`üìã Team ID: ${currentTeamId}`, "info");
          log("üîó Client configured to use database-access", "info");

          updateStatus("connected", "Geotrigger Client Ready");
          enableButtons();
        } catch (error) {
          log(
            `‚ùå Failed to initialize Geotrigger Client: ${error.message}`,
            "error"
          );
          updateStatus("disconnected", "Initialization Failed");
        }
      };

      window.testAuthentication = async function () {
        if (!geotriggerClient) {
          log("‚ùå Geotrigger client not initialized", "error");
          return;
        }

        try {
          const token = await geotriggerClient.authenticate();
          log("‚úÖ Authentication test successful!", "success");
          log(`üéüÔ∏è Token preview: ${token.substring(0, 50)}...`, "info");
          authToken = token;
        } catch (error) {
          log(`‚ùå Authentication test failed: ${error.message}`, "error");
        }
      };

      window.listGeotriggers = async function () {
        if (!geotriggerClient) {
          log("‚ùå Geotrigger client not initialized", "error");
          return;
        }

        try {
          log("üìã Fetching geotriggers...", "info");
          const geotriggers = await geotriggerClient.listGeotriggers();
          log(`‚úÖ Found ${geotriggers.length} geotriggers`, "success");

          geotriggers.forEach((geotrigger, index) => {
            const config = geotrigger.config || {};
            log(
              `  ${index + 1}. ${config.name || 'Unnamed'} (${config.status || 'unknown'}) - ${config.event_type || "N/A"}`,
              "info"
            );
            log(`     ID: ${geotrigger.id}`, "info");
            if (config.radius) {
              log(`     Radius: ${config.radius}m`, "info");
            }
            if (config.location) {
              log(`     Location: ${config.location.latitude}, ${config.location.longitude}`, "info");
            }
            if (config.description) {
              log(`     Description: ${config.description}`, "info");
            }
          });

          if (geotriggers.length === 0) {
            log("‚ÑπÔ∏è No geotriggers found", "info");
          }
        } catch (error) {
          log(`‚ùå Failed to list geotriggers: ${error.message}`, "error");
        }
      };

      window.getGeotriggerStats = async function () {
        if (!geotriggerClient) {
          log("‚ùå Geotrigger client not initialized", "error");
          return;
        }

        try {
          log("üìä Fetching geotrigger statistics...", "info");
          const stats = await geotriggerClient.getGeotriggerStats();
          log("‚úÖ Geotrigger stats retrieved:", "success");
          log(`  üìà Total: ${stats.totalGeotriggers}`, "info");
          log(`  üü¢ Active: ${stats.activeGeotriggers}`, "info");
          log(`  ‚ö™ Inactive: ${stats.inactiveGeotriggers}`, "info");
          log(`  üÜî Team ID: ${stats.teamId}`, "info");
        } catch (error) {
          log(`‚ùå Failed to get geotrigger stats: ${error.message}`, "error");
        }
      };

      window.createGeotrigger = async function () {
        if (!geotriggerClient) {
          log("‚ùå Geotrigger client not initialized", "error");
          return;
        }

        try {
          const name = document.getElementById("geotriggerName").value.trim();
          const latitude = parseFloat(document.getElementById("geotriggerLatitude").value);
          const longitude = parseFloat(document.getElementById("geotriggerLongitude").value);
          const radius = parseInt(document.getElementById("geotriggerRadius").value);

          if (!name || isNaN(latitude) || isNaN(longitude) || isNaN(radius)) {
            log("‚ùå Please fill in all required fields", "error");
            return;
          }

          let eventPayload;
          try {
            eventPayload = JSON.parse(document.getElementById("geotriggerPayload").value);
          } catch (e) {
            log("‚ùå Invalid JSON in event payload", "error");
            return;
          }

          const geotriggerData = {
            name: name,
            description: document.getElementById("geotriggerDescription").value.trim(),
            location: {
              latitude: latitude,
              longitude: longitude,
            },
            coordinates: `POINT(${longitude} ${latitude})`, // PostGIS format
            radius: radius,
            event_type: document.getElementById("geotriggerEventType").value,
            event_payload: eventPayload,
            status: document.getElementById("geotriggerStatus").value,
            team_id: geotriggerClient.teamId,
          };

          log("‚ûï Creating geotrigger...", "info");
          log(`üìù Location: ${latitude}, ${longitude}`, "info");
          log(`üìè Radius: ${radius}m`, "info");
          log(`üéØ Event Type: ${geotriggerData.event_type}`, "info");

          const result = await geotriggerClient.createGeotrigger(geotriggerData);
          log("‚úÖ Geotrigger created successfully!", "success");
          log(`üìä Created geotrigger ID: ${result.id || result[0]?.id}`, "success");
        } catch (error) {
          log(`‚ùå Failed to create geotrigger: ${error.message}`, "error");
        }
      };

      window.getGeotrigger = async function () {
        if (!geotriggerClient) {
          log("‚ùå Geotrigger client not initialized", "error");
          return;
        }

        const id = document.getElementById("managementId").value.trim();
        if (!id) {
          log("‚ùå Please enter a geotrigger ID", "error");
          return;
        }

        try {
          log(`üîç Fetching geotrigger: ${id}`, "info");
          const geotrigger = await geotriggerClient.getGeotrigger(id);
          log("‚úÖ Geotrigger retrieved:", "success");
          log(JSON.stringify(geotrigger, null, 2), "info");
        } catch (error) {
          log(`‚ùå Failed to get geotrigger: ${error.message}`, "error");
        }
      };

      window.updateGeotriggerStatus = async function () {
        if (!geotriggerClient) {
          log("‚ùå Geotrigger client not initialized", "error");
          return;
        }

        const id = document.getElementById("managementId").value.trim();
        const status = document.getElementById("newStatus").value;
        if (!id) {
          log("‚ùå Please enter a geotrigger ID", "error");
          return;
        }

        try {
          // First, verify the geotrigger exists
          log(`üîç Verifying geotrigger exists: ${id}`, "info");
          const geotrigger = await geotriggerClient.getGeotrigger(id);
          log(`‚úÖ Found geotrigger: ${geotrigger.config?.name || 'Unnamed'}`, "info");
          log(`üìä Current status: ${geotrigger.config?.status || 'unknown'}`, "info");

          log(`üîÑ Updating geotrigger status: ${id} -> ${status}`, "info");
          
          // Debug: Log the exact request being made
          log(`üîç Debug: About to call updateGeotriggerStatus with:`, "info");
          log(`  - ID: ${id}`, "info");
          log(`  - Status: ${status}`, "info");
          
          await geotriggerClient.updateGeotriggerStatus(id, status);
          log("‚úÖ Geotrigger status updated successfully!", "success");
          
          // Verify the update worked
          const updated = await geotriggerClient.getGeotrigger(id);
          if (updated.config?.status === status) {
            log(`‚úÖ Confirmed: Status is now ${updated.config.status}`, "success");
          } else {
            log(`‚ö†Ô∏è Warning: Status may not have updated (current: ${updated.config?.status})`, "warning");
            log("üí° Tip: This might be a database permissions (RLS) issue", "info");
          }
        } catch (error) {
          log(`‚ùå Failed to update geotrigger status: ${error.message}`, "error");
          if (error.message.includes("Failed to get geotrigger")) {
            log("üí° Tip: Check if the geotrigger ID is correct", "info");
          } else {
            log("üí° Tip: This might be a database permissions (RLS) issue", "info");
          }
        }
      };

      window.duplicateGeotrigger = async function () {
        if (!geotriggerClient) {
          log("‚ùå Geotrigger client not initialized", "error");
          return;
        }

        const id = document.getElementById("managementId").value.trim();
        if (!id) {
          log("‚ùå Please enter a geotrigger ID", "error");
          return;
        }

        try {
          log(`üìã Duplicating geotrigger: ${id}`, "info");
          const duplicate = await geotriggerClient.duplicateGeotrigger(id);
          log("‚úÖ Geotrigger duplicated successfully!", "success");
          log(`üìä New geotrigger ID: ${duplicate.id}`, "success");
        } catch (error) {
          log(`‚ùå Failed to duplicate geotrigger: ${error.message}`, "error");
        }
      };

      window.deleteGeotrigger = async function () {
        if (!geotriggerClient) {
          log("‚ùå Geotrigger client not initialized", "error");
          return;
        }

        const id = document.getElementById("managementId").value.trim();
        if (!id) {
          log("‚ùå Please enter a geotrigger ID", "error");
          return;
        }

        if (!confirm(`Are you sure you want to delete geotrigger ${id}?`)) {
          return;
        }

        try {
          // First, verify the geotrigger exists and get its details
          log(`üîç Verifying geotrigger exists: ${id}`, "info");
          const geotrigger = await geotriggerClient.getGeotrigger(id);
          log(`‚úÖ Found geotrigger: ${geotrigger.config?.name || 'Unnamed'}`, "info");
          log(`üÜî Team ID in config: ${geotrigger.config?.team_id}`, "info");
          log(`üîó Workflow ID: ${geotrigger.workflow_id}`, "info");

          // Now attempt deletion
          log(`üóëÔ∏è Deleting geotrigger: ${id}`, "info");
          await geotriggerClient.deleteGeotrigger(id);
          log("‚úÖ Geotrigger deleted successfully!", "success");
          
          // Verify deletion worked
          try {
            const verifyResult = await geotriggerClient.getGeotrigger(id);
            if (!verifyResult || (Array.isArray(verifyResult) && verifyResult.length === 0)) {
              log("‚úÖ Confirmed: Geotrigger no longer exists", "success");
            } else {
              log("‚ö†Ô∏è Warning: Geotrigger still exists after deletion - may be RLS policy issue", "warning");
            }
          } catch (verifyError) {
            log("‚úÖ Confirmed: Geotrigger no longer exists (threw error)", "success");
          }
        } catch (error) {
          log(`‚ùå Failed to delete geotrigger: ${error.message}`, "error");
          if (error.message.includes("Failed to get geotrigger")) {
            log("üí° Tip: Check if the geotrigger ID is correct", "info");
          } else {
            log("üí° Tip: This might be a database permissions (RLS) issue", "info");
          }
        }
      };

      window.getCurrentLocation = async function () {
        if (!geotriggerClient) {
          log("‚ùå Geotrigger client not initialized", "error");
          return;
        }

        try {
          log("üìç Getting current location...", "location");
          const location = await geotriggerClient.getCurrentLocation();
          currentLocation = location;

          log(`‚úÖ Location: ${location.latitude}, ${location.longitude}`, "location");
          log(`üìä Accuracy: ${location.accuracy}m`, "location");

          // Update location display
          document.getElementById("location-display").style.display = "block";
          document.getElementById("location-info").innerHTML = `
            <strong>Latitude:</strong> ${location.latitude.toFixed(6)}<br>
            <strong>Longitude:</strong> ${location.longitude.toFixed(6)}<br>
            <strong>Accuracy:</strong> ${location.accuracy}m
          `;

          // Update form fields
          document.getElementById("geotriggerLatitude").value = location.latitude.toFixed(6);
          document.getElementById("geotriggerLongitude").value = location.longitude.toFixed(6);
        } catch (error) {
          log(`‚ùå Failed to get location: ${error.message}`, "error");
        }
      };

      window.useCurrentLocation = async function () {
        if (!currentLocation) {
          log("‚ùå No current location available. Get location first.", "error");
          return;
        }

        document.getElementById("geotriggerLatitude").value = currentLocation.latitude.toFixed(6);
        document.getElementById("geotriggerLongitude").value = currentLocation.longitude.toFixed(6);
        log("‚úÖ Current location applied to form", "location");
      };

      window.startMonitoring = async function () {
        if (!geotriggerClient) {
          log("‚ùå Geotrigger client not initialized", "error");
          return;
        }

        if (geotriggerClient.isMonitoring()) {
          log("‚ö†Ô∏è Already monitoring", "warning");
          return;
        }

        try {
          // Add a test region
          geotriggerClient.addRegion({
            id: "test-region",
            center: {
              latitude: 37.7749,
              longitude: -122.4194,
            },
            radius: 100,
            name: "Test Region",
          });

          log("üîç Starting geofence monitoring...", "location");
          await geotriggerClient.startMonitoring((event) => {
            log(`üéØ Geofence ${event.type}: ${event.regionId}`, "location");
            log(`üìç Location: ${event.location.latitude}, ${event.location.longitude}`, "location");
          });

          log("‚úÖ Geofence monitoring started", "location");
          document.getElementById("stopBtn").disabled = false;
        } catch (error) {
          log(`‚ùå Failed to start monitoring: ${error.message}`, "error");
        }
      };

      window.stopMonitoring = function () {
        if (!geotriggerClient) {
          log("‚ùå Geotrigger client not initialized", "error");
          return;
        }

        geotriggerClient.stopMonitoring();
        document.getElementById("stopBtn").disabled = true;
        log("‚úÖ Geofence monitoring stopped", "location");
      };

      // Initialize
      log("üåê Geotrigger Module Test Ready (Enhanced Version)", "info");
      log('üìã Enter your credentials and click "Initialize Geotrigger Client"', "info");
      log("üåç Full CRUD operations and browser location services available", "info");
    </script>
  </body>
</html>